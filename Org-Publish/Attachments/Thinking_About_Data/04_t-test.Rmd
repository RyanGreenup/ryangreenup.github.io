---
title: "04 Smoking 2"
tags: [Notebooks/Thinking About Data]
output: 
  html_notebook: 
    toc: yes
---

# Comparison of Samples with *Student*'s $t$ test
## Preamble

```{r}
# Preamble
## Install Pacman
load.pac <- function() {
  
  if(require("pacman")){
    library(pacman)
  }else{
    install.packages("pacman")
    library(pacman)
  }
  
  pacman::p_load(xts, sp, gstat, ggplot2, rmarkdown, reshape2, ggmap,
                 parallel, dplyr, plotly, tidyverse, reticulate, UsingR, Rmpfr,
                 swirl, corrplot, gridExtra, mise, latex2exp, tree, rpart, lattice)
  
}

load.pac()
mise()
load(file = "./TAD.rdata")
```

Load the Data

```{r}
(birthwt <- as_tibble(read.csv(file = "./0datasets/birthwt.csv", header = TRUE, sep = ",")))

 # Always use doubles / numeric unless the data is legitamately
   # restricted to the integers, it will break functions ( and so it should)
birthwt$bwt <- as.numeric(birthwt$bwt)

birthwt$smoke <- c(FALSE, TRUE)[birthwt$smoke]

summary(birthwt)
str(birthwt)
dim(birthwt)
nrow(birthwt)
ncol(birthwt)
```


## Smoking and Birth Weight
### Summarise Data
#### Table

```{r}
table(birthwt$smoke)
table(birthwt$smoke) %>% barplot(main = "Birth Weight and Smoking")
```

#### Barplot

```{r}

desc_stats <- function(x) {
  mean(x)
  median(x)
  var(x)
  sd(x)
}

(desc_stats <- data.frame(
mean = apply(birthwt, 2, mean),
median = apply(birthwt, 2, median),
var = apply(birthwt, 2, var),
sd = apply(birthwt, 2, sd)
))

```

##### Range

```{r}
range(birthwt$bwt)
range(birthwt$bwt) %>% diff()
max(birthwt$bwt) - min(birthwt$bwt)
```

###### Quantile

The quantile function returns $x$ -axis values corresponding to a what proportion of the data is specified, so for example, for a standard normal distribution $\mathcal{N}~\left( 0, 1 \right)$, 2.5% of the observations lie below 2 and another 2.5% lie above 2.

```{r}
quantile(rnorm(1000), 0.025)

quantile(birthwt$bwt, 0.25)
quantile(birthwt$bwt, 0.75)
```

###### Inter-Quartile Range

This can be calculated thusly:

```{r}
IQR(birthwt$bwt)
```


For normally distributed data we would expect:

$$
\textsf{IQR} = 1.349 \times \sigma
$$

Remember tha the normal distribution is modelled using calculus:

$$
\begin{aligned}
f(x) &= - \sqrt{\frac{k}{2\pi}}  \cdot   e^{k\cdot  \frac{\left( x- \mu \right)^2}{2}} \\
    f\left( x \right)&= \sqrt{\frac{1}{2\pi}}\cdot  \sum^{\infty}_{n= 0}   \left[\frac{ \left( - \frac{1}{2}z^2 \right)^n}{n!} \right]  \\
\int f\left( x \right) \mathrm{d}x &= \frac{1}{\sqrt{2\pi} }\int \sum^{\infty}_{n= 0}   \left[ \frac{\left( - \frac{1}{2}z^2 \right)^n}{n!} \right]  \mathrm{d}z \\
&= \frac{1}{\sqrt{2\pi} }\cdot  \sum^{\infty}_{n= 0}   \left[ \int \frac{\left( - 1 \right)^{- 1}z^{2n}}{2^n\cdot  n!} \mathrm{d}z  \right] \\
&= \frac{1}{\sqrt{2\pi} }\cdot  \sum^{\infty}_{n= 0}   \left[ \frac{\left( - 1 \right)^n \cdot  z^{2n+ 1}}{2^n\left( 2n+  1 \right)n!} \right] 
\end{aligned}
$$


#### Histograms

A histogram would offer a better understanding of the data:

```{r}
x <- birthwt$bwt
hist(birthwt$bwt, main = "Histogram of Birth Weight Given Smoking", col = "lightblue", border = "indianred", freq = FALSE)
# curve(dnorm(x, mean(x), sd(x)), add = TRUE)
```

Adding a Density urve is extremely difficult in base plot, it's so much easier to use ggplot2:

```{r}
birthwt_pretty <- birthwt
birthwt_pretty$smoke <- ifelse(birthwt$smoke, "Smoking", "non\nSmoking")

hist <- ggplot(birthwt_pretty, aes(x = bwt, fill = smoke, col = "black", y = ..density..)) +
         theme_classic() + 
         labs(x = "Birth Weight", y = "Density")

plots <- list()

# Dodge
plots[[1]] <- hist + geom_histogram(position = "dodge2", col = "blue", binwidth = 300)

# Overlay
plots[[2]] <-  hist + geom_histogram(binwidth = 300, col = "black")

# Single Histogram
plots[[3]] <- hist + geom_histogram(binwidth = 300, col = "black", aes(group = 1), fill = "lightblue") 

# Facet Grid (i.e. Split Chart)
 plots[[4]] <- hist + geom_histogram(binwidth = 300, col = "black") +
         facet_grid(. ~ smoke) +
         guides(fill = FALSE)

  
  # Colour it
  # Make a Facet Grid
  # Add a Density Curve

```

```{r}
layout <- matrix(c(1, 1, 2, 3, 4, 4), byrow = TRUE, nrow = 3)
# arrangeGrob(grobs = plots, layou_tmatrix = layout)
grid.arrange(grobs = plots, layout_matrix = layout)


```


#### Splitting the Data Up

The `aggregate()` function can split up data by a specified variable given a `formula`:

```{r}
bwt_form <- bwt~smoke

# Formula as a variable
aggregate(bwt_form, birthwt, mean)

# Otherwise
aggregate(bwt~smoke, birthwt, sd)
aggregate(bwt~smoke, birthwt, median)
```
It would also be possible to do this manually but it's actually quite tricky:
> Tibble's will always remain as tibble's when a column is extracted and will not yield to `as.vector()`, it is necessary to instead use the `dplyr::pull()` function or first conver the tibble to a matrix.


```{r}

matrix(
  c(
"Mean_Smokers"  = as.matrix(birthwt)[birthwt$smoke==1,"bwt"] %>% mean(),
"Mean_NonSmoke" = as.matrix(birthwt)[birthwt$smoke==0,"bwt"] %>% mean()
))

```


#### Split Charts

##### Base

Split Charts are essentially a `facet grid` of two historgrams corresponding to a variable, the can be generated using the `lattice` library which is usually bundled with base **_R_**: 

```{r}
library(lattice)
histogram(~bwt|smoke, data = birthwt)
```



##### GGPlot2 

This was shown previously:

```{r}
# Facet Grid

ggplot(birthwt_pretty, aes(x = bwt, fill = smoke, col = "black", y = ..density..)) +
         geom_histogram(binwidth = 300, col = "black") +
         facet_grid(. ~ smoke) +
         guides(fill = FALSE) +
         theme_classic() + 
         labs(x = "Birth Weight", y = "Density")
```

#### Box Plots

##### Base 
This is varily easy if the data is such that one variable is a factor/logical, the syntax uses a `formula`, so in this case `Y ~ X` would by *birthweights depends on smoking* [^1]:

[^1]: As opposed to smoking depending on birthweight.
###### Vertical
```{r}
birthwt_pretty <- birthwt
birthwt_pretty$smoke <- ifelse(birthwt$smoke, "Smoking", "Non-Smoking")
boxplot(bwt ~ smoke, birthwt_pretty,
        col = "lightblue", main = "Comparison of Birthweight Given Smoking",
        xlab = "", ylab = "Birth Weight", cex = 2, pch = 3)
```

###### Horizontal

```{r}
birthwt_pretty <- birthwt
birthwt_pretty$smoke <- ifelse(birthwt$smoke, "Smoking", "Non-Smoking")
boxplot(bwt ~ smoke, birthwt_pretty,
        col = "lightblue", main = "Comparison of Birthweight Given Smoking",
        xlab = "", ylab = "Birth Weight", cex = 2, pch = 3, horizontal = TRUE)
```

##### GGPlot2

```{r}
ggplot(birthwt, aes(x = smoke, y = bwt, fill = smoke)) +
  geom_boxplot(show.legend = FALSE) +
  scale_x_discrete(labels = c("Non\nSmoking", "Smoking")) + 
  theme_classic() + 
  labs(x = "", y = "Birth Weight", title = "Comparison of Birthweight Given Smoking Habits")
  
  
  
```

### Difference in Means

```{r}
(birthwt_agg <- aggregate(bwt ~ smoke, data = birthwt, FUN = mean))

